#+title: zfs-snap-diff
#+hugo_base_dir: .
#+options: creator:t author:nil

* Index
:PROPERTIES:
:export_title: zfs-snap-diff
:export_file_name: _index
:export_hugo_section: /
:export_hugo_weight: 10
:export_hugo_type: docs
:END:
** Intro

{{< hint danger >}}
This describes the currently **unreleased alpha version**.
{{< /hint >}}

~zfs-snap-diff~ searches different file versions in your zfs snapshots for you.

If you have hundreds or thousands of zfs snapshots, ~zfs-snap-diff~ searched
the snapshots and shows you only the snapshots where a given file was modified.

To speedup this process, it performs the search incremental when you request a older file version.

You can inspect a diff from the actual file version to the older file version in the
snapshot, revert a single change or restore a whole file.

** Usage

  - install ~zfs-snap-diff~

see: [[/docs/install][Installation]]

  - startup a server instance
#+BEGIN_SRC sh
./zfs-snap-diff [OPTIONS] <ZFS_DATASET_NAME>
#+END_SRC

This starts a embedded webserver and serves the included web-app.

  - open your webbrowser at
#+BEGIN_SRC sh
http://127.0.0.1:12345
#+END_SRC

  - inspect a diff and revert to a older version
 #+attr_html: :alt Example session from zfs-snap-diff
 [[/images/zfs-snap-diff.gif][file:/images/zfs-snap-diff.gif]]



* Installation
  :PROPERTIES:
  :export_file_name: install
  :export_hugo_weight: 20
  :export_hugo_section: docs
  :END:

{{< hint danger >}}
This describes the currently **unreleased alpha version**.
{{< /hint >}}

If you need a 32bit version, or a binary for a different
platform, feel free to contact me!

The tgz archive contains [[/docs/guide/#zfs-snap-diff][zfs-snap-diff]] and [[/docs/guide/#zsd][zsd]].

#+BEGIN_SRC elisp :results output raw :exports results
  (defun exec-to-string (cmd)
    "Execute the given CMD and return stdout."
    (s-trim-right
     (with-output-to-string
       (with-current-buffer
           standard-output
         (process-file shell-file-name nil '(t nil)  nil shell-command-switch cmd)))))

  (defun version-string ()
    "Lookup the actual `zfs-snap-diff' version."
    (exec-to-string "git describe --always"))

  (defun archive-name-string (platform)
    "Generate the archive name for the given PLATFORM."
    (format "zfs-snap-diff-%s-%s.tgz" platform (version-string)))


  (defun section-for (platform artifact)
    (format (concat "*** %s\n\n"
                    "Download the alpha version for %s amd64 here:\n\n"
                    "[[/%s][%s]]\n\n"
                    "_Try with the `-use-sudo` if it's not working - and please give feedbak if somethink is not working_\n\n"
            ) platform platform artifact artifact))

  (princ (section-for "Linux" (archive-name-string "linux")))
  (princ (section-for "FreeBSD" (archive-name-string "freebsd")))
  (princ (section-for "macOS" (archive-name-string "darwin")))
  (princ (section-for "Solaris" (archive-name-string "solaris")))
#+END_SRC

#+RESULTS:
*** Linux

Download the alpha version for Linux amd64 here:

[[/zfs-snap-diff-linux-v1.0.0-alpha-13-gaeec2f1.tgz][zfs-snap-diff-linux-v1.0.0-alpha-13-gaeec2f1.tgz]]

_Try with the `-use-sudo` if it's not working - and please give feedbak if somethink is not working_

*** FreeBSD

Download the alpha version for FreeBSD amd64 here:

[[/zfs-snap-diff-freebsd-v1.0.0-alpha-13-gaeec2f1.tgz][zfs-snap-diff-freebsd-v1.0.0-alpha-13-gaeec2f1.tgz]]

_Try with the `-use-sudo` if it's not working - and please give feedbak if somethink is not working_

*** macOS

Download the alpha version for macOS amd64 here:

[[/zfs-snap-diff-darwin-v1.0.0-alpha-13-gaeec2f1.tgz][zfs-snap-diff-darwin-v1.0.0-alpha-13-gaeec2f1.tgz]]

_Try with the `-use-sudo` if it's not working - and please give feedbak if somethink is not working_

*** Solaris

Download the alpha version for Solaris amd64 here:

[[/zfs-snap-diff-solaris-v1.0.0-alpha-13-gaeec2f1.tgz][zfs-snap-diff-solaris-v1.0.0-alpha-13-gaeec2f1.tgz]]

_Try with the `-use-sudo` if it's not working - and please give feedbak if somethink is not working_











*** Build from source

**** ~go~

The minimum supported go version is =go1.12=.

  - clone this repo: ~git clone -b dev https://github.com/j-keck/zfs-snap-diff~
  - change to the checkout directory: ~cd zfs-snap-diff~
  - build it: ~go build -ldflags="-X main.version=$(git describe)" ./cmd/zfs-snap-diff~

The optional ~-ldflags="-X main.version=$(git describe)"~ flag updates the ~version~ string in the binary.

**** ~nix~

The ~nix~ build also compiles the frontend to javascript and decode it in ~pkg/webapp/bindata.go~.

  - clone this repo: ~git clone -b dev https://github.com/j-keck/zfs-snap-diff~
  - change to the checkout directory: ~cd zfs-snap-diff~
  - build it: ~nix-build -A zfs-snap-diff~

The build artifacts ~zfs-snap-diff~ and ~zsd~ are in ~./result/bin/~.

To crosscompile the binary use:

  - FreeBSD: ~nix-build -A zfs-snap-diff --argstr goos freebsd~
  - MacOS: ~nix-build -A zfs-snap-diff --argstr goos darwin~
  - Solaris: ~nix-build -A zfs-snap-diff --argstr goos solaris~


* User Guide
  :PROPERTIES:
  :export_file_name: guide
  :export_hugo_weight: 30
  :export_hugo_section: docs
  :END:

{{< hint danger >}}
This describes the currently **unreleased alpha version**.
{{< /hint >}}

** ~zfs-snap-diff~

*** Browse the actual filesytem

You can browse the actual filesystem an inspect a diff from the actual file version to the older
file version in the selected snapshot, revert a single change or restore a whole file.

   #+attr_html: :alt Screenshot from 'Browse filesystem'
   [[/images/browse-filesystem.png][file:/images/browse-filesystem.png]]


*** Browse snapshots

In this view you can view the content of your snapshots.

  #+attr_html: :alt Screenshot from 'Browse snapshots
  [[/images/browse-snapshots.png][file:/images/browse-snapshots.png]]



** ~zsd~

~zsd~ is a little cli tool to revert a file on the command line.

  - list zfs-snapshots where the given file was modified
#+BEGIN_SRC sh
main⟩ ./zsd go.mod list
  # | Snapshot                               | Snapshot age
-----------------------------------------------------------
  0 | zfs-auto-snap_hourly-2020-02-12-12h00U | 5 hours
  1 | zfs-auto-snap_hourly-2020-02-12-09h00U | 8 hours
#+END_SRC

  - show the differences between the actual version and from the given snapshot
#+BEGIN_SRC sh
main⟩ ./zsd go.mod diff 0
Diff from the actual version to the version from: 2020-02-12 10:07:44.434355182 +0100 CET
module github.com/j-keck/zfs-snap-diff

require (
	github.com/BurntSushi/toml v0.3.1
	github.com/j-keck/go-diff v1.0.0
-	github.com/j-keck/plog v0.5.0
+	github.com/j-keck/plog v0.6.0
	github.com/stretchr/testify v1.4.0 // indirect
)

go 1.12
#+END_SRC

  - restore the given file with an older version
#+BEGIN_SRC sh
main⟩ ./zsd go.mod revert 0
backup from the actual version created at: /home/j/.cache/zfs-snap-diff/backups/home/j/prj/priv/zfs-snap-diff/go.mod_20200212_182709%
#+END_SRC


* Changelog
:PROPERTIES:
:export_file_name: changelog
:export_hugo_weight: 40
:export_hugo_section: docs
:END:


** 1.0.0-alpha (unreleased)

{{< hint note >}}
This version is a complete rewrite.

The backend is implemented in [[https://golang.org][Go]] (as before) and the frontend in [[http://purescript.org][PureScript]].
{{< /hint >}}

  - download a complete directory as zip-archive

  - date-range based search for file versions
    - this speeds up the scan dramatically if
      there are thousands snapshots on spinning disk

  - bookmark support
    - bookmarks are per dataset and stored in the browser ([[https://en.wikipedia.org/wiki/Web_storage][Web storage]]).

  - works now also with 'legacy' mountpoints

  - new backend and frontend code

[[https://github.com/j-keck/zfs-snap-diff/compare/0.0.10...dev][all commits from 0.0.10...dev]]

** 0.0.10

  - use relative url for service endpoints
    - to use zfs-snap-diff behind a reverse proxy
    - minimal example config snipped for nginx:

          location /zfs-snap-diff/ {
              proxy_pass http://localhost:12345/;
          }

  - optional tls encryption
  - listen address per '-l' flag configurable

[[https://github.com/j-keck/zfs-snap-diff/compare/0.0.9...0.0.10][all commits from 0.0.9...0.0.10]]

** 0.0.9

  - show file size and modify timestamp in the file-browser
  - list directories at first in the file-browser
  - sortable columns in the file-browser
  - only regular files / directories are clickable

[[https://github.com/j-keck/zfs-snap-diff/compare/0.0.8...0.0.9][all commits from 0.0.8...0.0.9]]

** 0.0.8

  * dataset selectable in 'browse-actual' view
  * add size informations to dataset (to match 'zfs list' output)
  * small fixes
  * code cleanup

[[https://github.com/j-keck/zfs-snap-diff/compare/0.0.7...0.0.8][all commits from 0.0.7...0.0.8]]

** 0.0.7

  - support sub zfs filesystems (datasets)
  - optional use sudo when execute zfs commands
    - necessary under linux when running as non root
    - needs sudo rules
    - start `zfs-snap-diff` with-'-use-sudo'
  - new view for server messages

[[https://github.com/j-keck/zfs-snap-diff/compare/0.0.6...0.0.7][all commits from 0.0.6...0.0.7]]

** 0.0.6

  - check if file in snapshot has changed filetype depend:
    - text files: md5
    - others: size+modTime
  - diffs created in the backend (per [[https://github.com/sergi/go-diff][go-diff]])
    - different presentation: intext / sid- by side
    - possibility to revert single changes

[[https://github.com/j-keck/zfs-snap-diff/compare/0.0.5...0.0.6][all commits from 0.0.5...0.0.6]]


** 0.0.5

  - file compare method configurable: size+modTime (default) or md5
  - optional limit how many snapshots are scan to search older file version
  - autohide notifications in frontend
  - show message if no snapshots found

[[https://github.com/j-keck/zfs-snap-diff/compare/0.0.4...0.0.5][all commits from 0.0.4...0.0.5]]

** 0.0.4

  - view, diff, download or restore file from a snapshot
  - view file with syntax highlight
  - browse old snapshot versions
  - easy switch "versions" per 'Older' / 'Newer' buttons
  - cleanup frontend
  - refactor backend

[[https://github.com/j-keck/zfs-snap-diff/compare/0.0.3...0.0.4][all commits 0.0.3...0.0.4]]

** 0.0.3

  - show server errors on frontend
  - show waiting spinner when loading

[[https://github.com/j-keck/zfs-snap-diff/compare/0.0.2...0.0.3][all commits 0.0.2...0.0.3]]

** 0.0.2

  - partial frontend configuration from server
  - fix firefox ui

[[https://github.com/j-keck/zfs-snap-diff/compare/0.0.1...0.0.2][all commits 0.0.1...0.0.2]]

** 0.0.1

  - prototype
