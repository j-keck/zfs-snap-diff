*  ~zfs-snap-diff~

This branch contains the next ~zfs-snap-diff~ version: ~1.0.0~.
It's a complete rewrite:

  - backend is implemented in [[https://golang.org][Go]] (as before)
  - frontend in [[http://purescript.org][PureScript]] (with [[https://pursuit.purescript.org/packages/purescript-react-basic][react-basic]])

You need only ~go~ to build this project.
I compile the frontend code to javascript and decode it in ~pkg/webapp/bindata.go~.


** Build from source

*** Build with ~go~

  - clone this repo: ~git clone -b dev https://github.com/j-keck/zfs-snap-diff~
  - change to the checkout directory: ~cd zfs-snap-diff~
  - build it: ~go build -ldflags="-X main.version=$(git describe)" ./cmd/zfs-snap-diff~

The optional ~-ldflags="-X main.version=$(git describe)"~ flag updates the ~version~ string in the binary.

*** Build with ~nix~

The ~nix~ build also compiles the frontend to javascript and decode it in ~pkg/webapp/bindata.go~.

  - clone this repo: ~git clone -b dev https://github.com/j-keck/zfs-snap-diff~
  - change to the checkout directory: ~cd zfs-snap-diff~
  - build it: ~nix-build -A zfs-snap-diff~

To crosscompile the binary for

  - FreeBSD: ~nix-build -A zfs-snap-diff --argstr goos freebsd~
  - MacOS: ~nix-build -A zfs-snap-diff --argstr goos darwin~
  - Solaris: ~nix-build -A zfs-snap-diff --argstr goos solaris~


** Run it

    ~./zfs-snap-diff <POOL>~

 [[./doc/browse-filesystem.png][file:./doc/browse-filesystem.png]]


** Changes


  - date-range based search for file versions
    - this speeds up the scan dramatically if
      there are thousands snapshots on spinning disk
  - works now also with 'legacy' mountpoints
  - new backend and frontend code

** API

*** REST

**** ~api/find-file-versions~

| path      |          | /home/user/testfile.txt             |
| dateRange | optional | {from: 2020-05-10, to: 2020-05-15 } |

#+BEGIN_SRC sh :results output :exports both
http --ignore-stdin -v --pretty format \
  :12345/api/find-file-versions \
  path=/home/j/zsd-testfile \
  dateRange:='{"from": "2020-01-01", "to": "2021-01-01"}'
#+END_SRC

#+RESULTS:
#+begin_example
POST /api/find-file-versions HTTP/1.1
Accept: application/json, */*
Accept-Encoding: gzip, deflate
Connection: keep-alive
Content-Length: 89
Content-Type: application/json
Host: localhost:12345
User-Agent: HTTPie/1.0.3

{
    "dateRange": {
        "from": "2020-01-01",
        "to": "2021-01-01"
    },
    "path": "/home/j/zsd-testfile"
}

HTTP/1.1 200 OK
Content-Length: 1071
Content-Type: application/json
Date: Tue, 28 Jan 2020 19:18:01 GMT

{
    "dateRange": {
        "from": "2020-01-01",
        "to": "2021-01-01"
    },
    "fileVersions": [
        {
            "file": {
                "kind": "FILE",
                "modTime": "2020-01-28T20:13:41.124041127+01:00",
                "name": "zsd-testfile",
                "path": "/home/.zfs/snapshot/zfs-auto-snap_frequent-2020-01-28-19h15U/j/zsd-testfile",
                "size": 52
            },
            "snapshot": {
                "created": "2020-01-28T20:15:23+01:00",
                "dir": {
                    "kind": "DIR",
                    "modTime": "2020-01-28T20:15:23+01:00",
                    "name": "zfs-auto-snap_frequent-2020-01-28-19h15U",
                    "path": "/home/.zfs/snapshot/zfs-auto-snap_frequent-2020-01-28-19h15U",
                    "size": 0
                },
                "fullName": "zmain/zmain/home@zfs-auto-snap_frequent-2020-01-28-19h15U",
                "name": "zfs-auto-snap_frequent-2020-01-28-19h15U"
            }
        }
    ],
    "lastScannedSnapshot": {
        "created": "2020-01-28T20:15:23+01:00",
        "dir": {
            "kind": "DIR",
            "modTime": "2020-01-28T20:15:23+01:00",
            "name": "zfs-auto-snap_frequent-2020-01-28-19h15U",
            "path": "/home/.zfs/snapshot/zfs-auto-snap_frequent-2020-01-28-19h15U",
            "size": 0
        },
        "fullName": "zmain/zmain/home@zfs-auto-snap_frequent-2020-01-28-19h15U",
        "name": "zfs-auto-snap_frequent-2020-01-28-19h15U"
    },
    "scanDuration": 17172929,
    "snapsFileMissing": 39,
    "snapsScanned": 1,
    "snapsToScan": 39
}
#+end_example




**** ~api/revert-change~: Revert a single change

| acutalPath |   | /home/user/filename                      |
| backupPath |   | /home/.zfs/snapshot/snap01/user/filename |
| deltaIdx   |   | 0                                        |


#+BEGIN_SRC sh :results output :exports both
http --ignore-stdin -v --pretty format \
  :12345/api/revert-change \
  actualPath=/home/j/zsd-testfile \
  backupPath=/home/.zfs/snapshot/zfs-auto-snap_frequent-2020-01-28-19h15U/j/zsd-testfile \
  deltaIdx:=0
#+END_SRC

#+RESULTS:
#+begin_example
POST /api/revert-change HTTP/1.1
Accept: application/json, */*
Accept-Encoding: gzip, deflate
Connection: keep-alive
Content-Length: 146
Content-Type: application/json
Host: localhost:12345
User-Agent: HTTPie/1.0.3

{
    "actualPath": "/home/j/zsd-testfile",
    "backupPath": "/home/.zfs/snapshot/zfs-auto-snap_frequent-2020-01-28-19h15U/j/zsd-testfile",
    "deltaIdx": 0
}

HTTP/1.1 200 OK
Content-Length: 79
Content-Type: text/plain; charset=utf-8
Date: Tue, 28 Jan 2020 19:21:39 GMT

Change reverted - Backup created at '/home/j/.zsd/zsd-testfile_20200128_202139'
#+end_example



